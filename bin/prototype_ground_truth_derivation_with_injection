{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "4cb3c3e0-79be-4060-8fb5-7aef6b5a53f6",
   "metadata": {},
   "outputs": [],
   "source": [
    "#!/usr/bin/env python\n",
    "# coding: utf-8\n",
    "\n",
    "# Import required libraries and modules\n",
    "import numpy as np\n",
    "import matplotlib.pyplot as plt\n",
    "import pandas as pd\n",
    "from astropy.coordinates import SkyCoord\n",
    "import astropy.units as u\n",
    "from tqdm import tqdm"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0af7cf07-4a1e-4a03-9433-9ff22709ab2b",
   "metadata": {},
   "source": [
    "Generating truth sample for the injected DC2 run `u/elhoward/DM-45116/w_2024_33/DC2-with-injection`"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "97392093-b4c0-40ad-b4e3-1c30b59882e1",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>ra</th>\n",
       "      <th>dec</th>\n",
       "      <th>midpointMjdTai</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>diaSourceId</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>1253071204122625</th>\n",
       "      <td>59.253969</td>\n",
       "      <td>-35.865458</td>\n",
       "      <td>59583.120963</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1253071204122626</th>\n",
       "      <td>59.352831</td>\n",
       "      <td>-35.824191</td>\n",
       "      <td>59583.120963</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1253071204122627</th>\n",
       "      <td>59.322393</td>\n",
       "      <td>-35.837479</td>\n",
       "      <td>59583.120963</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1253071204122628</th>\n",
       "      <td>59.187448</td>\n",
       "      <td>-35.894133</td>\n",
       "      <td>59583.120963</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1253071204122629</th>\n",
       "      <td>59.357712</td>\n",
       "      <td>-35.822867</td>\n",
       "      <td>59583.120963</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>266819038615699894</th>\n",
       "      <td>58.511378</td>\n",
       "      <td>-36.092158</td>\n",
       "      <td>60309.228989</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>266819038615699895</th>\n",
       "      <td>58.506497</td>\n",
       "      <td>-36.097308</td>\n",
       "      <td>60309.228989</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>266819038615699897</th>\n",
       "      <td>58.470790</td>\n",
       "      <td>-36.139579</td>\n",
       "      <td>60309.228989</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>266819038615699898</th>\n",
       "      <td>58.565491</td>\n",
       "      <td>-36.033826</td>\n",
       "      <td>60309.228989</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>266819038615699899</th>\n",
       "      <td>58.525060</td>\n",
       "      <td>-36.079423</td>\n",
       "      <td>60309.228989</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>3508059 rows × 3 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "                           ra        dec  midpointMjdTai\n",
       "diaSourceId                                             \n",
       "1253071204122625    59.253969 -35.865458    59583.120963\n",
       "1253071204122626    59.352831 -35.824191    59583.120963\n",
       "1253071204122627    59.322393 -35.837479    59583.120963\n",
       "1253071204122628    59.187448 -35.894133    59583.120963\n",
       "1253071204122629    59.357712 -35.822867    59583.120963\n",
       "...                       ...        ...             ...\n",
       "266819038615699894  58.511378 -36.092158    60309.228989\n",
       "266819038615699895  58.506497 -36.097308    60309.228989\n",
       "266819038615699897  58.470790 -36.139579    60309.228989\n",
       "266819038615699898  58.565491 -36.033826    60309.228989\n",
       "266819038615699899  58.525060 -36.079423    60309.228989\n",
       "\n",
       "[3508059 rows x 3 columns]"
      ]
     },
     "execution_count": 10,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "\n",
    "# Define a threshold for matching errors\n",
    "space_match_threshold = 1 * u.arcsec\n",
    "MJD_tolerance = 31./(24*3600) #31 sec in units of day \n",
    "\n",
    "# Define file paths.\n",
    "sum_path = {}\n",
    "sum_path[\"star\"] = '../truth_star/truth_star_summary_v1-0-0.parquet'\n",
    "#'/sdf/data/rubin/shared/dc2_run2.2i_truth/truth_star/truth_star_summary_v1-0-0.parquet'\n",
    "sum_path[\"sn\"] = \"../truth_sn/truth_sn_summary_v1-0-0.parquet\" \n",
    "#'/sdf/data/rubin/shared/dc2_run2.2i_truth/truth_sn/truth_sn_summary_v1-0-0.parquet'\n",
    "\n",
    "# injected sources\n",
    "sum_path[\"inject\"] = '../test-DC2-injection-catalog.csv.gz'\n",
    "\n",
    "var_path = {}\n",
    "var_path[\"star\"] = '../truth_star/truth_star_variability_v1-0-0.parquet'\n",
    "#'/sdf/data/rubin/shared/dc2_run2.2i_truth/truth_star/truth_star_variability_v1-0-0.parquet'\n",
    "var_path[\"sn\"] = '../truth_sn/truth_sn_variability_v1-0-0.parquet'\n",
    "#'/sdf/data/rubin/shared/dc2_run2.2i_truth/truth_sn/truth_sn_variability_v1-0-0.parquet'\n",
    "\n",
    "\n",
    "\n",
    "detection_csv_pth = \"../all_diasources.csv.gz\" #'exported_sources.csv'\n",
    "\n",
    "#get DIA detections\n",
    "dia_detections = pd.read_csv(detection_csv_pth, index_col=\"diaSourceId\") #formerly known as exported_csv\n",
    "\n",
    "\n",
    "dia_detections"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "fe4cccd7-3d1d-46a2-be08-2fd31fb203c9",
   "metadata": {},
   "source": [
    "## load truth catalogs"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "cba01351-513b-4db4-88ff-6d215be51013",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Get mind and max ra and dec values to filter out unnecessary records.\n",
    "max_exp_ra, min_exp_ra = dia_detections.ra.max(), dia_detections.ra.min()\n",
    "max_exp_dec, min_exp_dec = dia_detections.dec.max(), dia_detections.dec.min()\n",
    "\n",
    "\n",
    "catalog = {}\n",
    "result_sum = {}\n",
    "\n",
    "# Stage 1: Match sources in Space.\n",
    "for s in [\"star\", \"sn\", \"inject\"]:\n",
    "    # Read Parquet and CSV files to begin ground truth derivation.\n",
    "    if sum_path[s].endswith('parquet'):\n",
    "        result_sum[s] = pd.read_parquet(sum_path[s])\n",
    "    else:\n",
    "        result_sum[s] = pd.read_csv(sum_path[s])\n",
    "\n",
    "    # Keep only those records from summary tables which are within the max ra and dec values in the exported sources.\n",
    "    result_sum[s] = result_sum[s][(result_sum[s]['ra'] >= min_exp_ra) & (result_sum[s]['ra'] <= max_exp_ra) &\\\n",
    "                                    (result_sum[s]['dec'] >= min_exp_dec) & (result_sum[s]['dec'] <= max_exp_dec)]\n",
    "\n",
    "\n",
    "    # Initialize astropy.coordinates.SkyCoord class for matching in space.\n",
    "    catalog[s] = SkyCoord(ra=result_sum[s].ra, dec=result_sum[s].dec, unit=u.deg)\n",
    "\n",
    "# Match exported sources with stars and supernovae.\n",
    "detections_cat = SkyCoord(ra=dia_detections.ra, dec=dia_detections.dec, unit=u.deg)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "d7c14c27-4a50-4393-a35d-06be8d11d6e8",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>injection_id</th>\n",
       "      <th>ra</th>\n",
       "      <th>dec</th>\n",
       "      <th>mag</th>\n",
       "      <th>source_type</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>0</td>\n",
       "      <td>58.758793</td>\n",
       "      <td>-35.758146</td>\n",
       "      <td>19.036632</td>\n",
       "      <td>Star</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>1</td>\n",
       "      <td>57.274012</td>\n",
       "      <td>-37.012349</td>\n",
       "      <td>22.536632</td>\n",
       "      <td>Star</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2</td>\n",
       "      <td>56.182822</td>\n",
       "      <td>-36.767262</td>\n",
       "      <td>20.786632</td>\n",
       "      <td>Star</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>3</td>\n",
       "      <td>57.626783</td>\n",
       "      <td>-36.773840</td>\n",
       "      <td>24.286632</td>\n",
       "      <td>Star</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>4</td>\n",
       "      <td>57.134388</td>\n",
       "      <td>-36.457476</td>\n",
       "      <td>18.161632</td>\n",
       "      <td>Star</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>47689</th>\n",
       "      <td>47689</td>\n",
       "      <td>57.480201</td>\n",
       "      <td>-35.786387</td>\n",
       "      <td>23.023158</td>\n",
       "      <td>Star</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>47690</th>\n",
       "      <td>47690</td>\n",
       "      <td>58.508305</td>\n",
       "      <td>-35.913646</td>\n",
       "      <td>21.273158</td>\n",
       "      <td>Star</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>47691</th>\n",
       "      <td>47691</td>\n",
       "      <td>57.337736</td>\n",
       "      <td>-36.804169</td>\n",
       "      <td>24.773158</td>\n",
       "      <td>Star</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>47692</th>\n",
       "      <td>47692</td>\n",
       "      <td>59.198191</td>\n",
       "      <td>-35.984369</td>\n",
       "      <td>18.648158</td>\n",
       "      <td>Star</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>47693</th>\n",
       "      <td>47693</td>\n",
       "      <td>56.516517</td>\n",
       "      <td>-36.450343</td>\n",
       "      <td>22.148158</td>\n",
       "      <td>Star</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>46907 rows × 5 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "       injection_id         ra        dec        mag source_type\n",
       "0                 0  58.758793 -35.758146  19.036632        Star\n",
       "1                 1  57.274012 -37.012349  22.536632        Star\n",
       "2                 2  56.182822 -36.767262  20.786632        Star\n",
       "3                 3  57.626783 -36.773840  24.286632        Star\n",
       "4                 4  57.134388 -36.457476  18.161632        Star\n",
       "...             ...        ...        ...        ...         ...\n",
       "47689         47689  57.480201 -35.786387  23.023158        Star\n",
       "47690         47690  58.508305 -35.913646  21.273158        Star\n",
       "47691         47691  57.337736 -36.804169  24.773158        Star\n",
       "47692         47692  59.198191 -35.984369  18.648158        Star\n",
       "47693         47693  56.516517 -36.450343  22.148158        Star\n",
       "\n",
       "[46907 rows x 5 columns]"
      ]
     },
     "execution_count": 15,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "result_sum[\"inject\"]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "95ec6417-0b0e-469b-a793-cb58f3dd7fff",
   "metadata": {},
   "outputs": [],
   "source": [
    "# By default, set on_source = 0 and real=0 (bogus) for all values in the exported sources.\n",
    "dia_detections['on_source'] = 0\n",
    "dia_detections['real'] = np.nan\n",
    "dia_detections['type'] = None"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "faffe912-ea47-43ac-9465-727b336a67c9",
   "metadata": {},
   "source": [
    "## spatial crossmatch"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "8b3c07bb-7988-4a68-8bd1-fa8529486750",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "211188 of 3508059 matched stars after applying spatial threshold\n",
      "2829 of 3508059 matched sne after applying spatial threshold\n",
      "3215924 of 3508059 matched injections after applying spatial threshold\n"
     ]
    }
   ],
   "source": [
    "# we want to put the DIA catalog first so we get a yes or no truth match for every DIASource\n",
    "star_idx, star_d2d, star_d3d = detections_cat.match_to_catalog_sky(catalog['star'])\n",
    "sn_idx, sn_d2d, sn_d3d = detections_cat.match_to_catalog_sky(catalog['sn'])\n",
    "inj_idx, inj_d2d, inj_d3d = detections_cat.match_to_catalog_sky(catalog['inject'])\n",
    "\n",
    "\n",
    "star_mask = star_d2d < space_match_threshold #remove matches that are too far\n",
    "sn_mask = sn_d2d < space_match_threshold #remove matches that are too far\n",
    "inj_mask = inj_d2d < space_match_threshold #remove matches that are too far\n",
    "\n",
    "\n",
    "print(f\"{np.sum(star_mask)} of {len(detections_cat)} matched stars after applying spatial threshold\")\n",
    "print(f\"{np.sum(sn_mask)} of {len(detections_cat)} matched sne after applying spatial threshold\")\n",
    "print(f\"{np.sum(inject_mask)} of {len(detections_cat)} matched injections after applying spatial threshold\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 31,
   "id": "31279364-2741-4bdc-9fca-a736fd1630b3",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Number of matched stars in Stage #1: 211188\n",
      "Number of matched sne in Stage #1: 2829\n",
      "Number of matched injections in Stage #1: 3215924\n"
     ]
    }
   ],
   "source": [
    "\n",
    "\n",
    "# Get all matched stars\n",
    "matched_star_idx = star_idx[star_mask] #index in stars of matched dia_detections\n",
    "print(f\"Number of matched stars in Stage #1: {len(matched_star_idx)}\")\n",
    "\n",
    "# Get all matched supernovae\n",
    "matched_sn_idx = sn_idx[sn_mask] #index in sn_cat of matched dia_detections\n",
    "print(f\"Number of matched sne in Stage #1: {len(matched_sn_idx)}\")\n",
    "\n",
    "# Get all matched injections\n",
    "matched_inj_idx = inj_idx[inj_mask] #index in sn_cat of matched dia_detections\n",
    "print(f\"Number of matched injections in Stage #1: {len(matched_inj_idx)}\")\n",
    "\n",
    "dia_idx_stars = dia_detections.index[star_mask]\n",
    "dia_idx_sn = dia_detections.index[sn_mask]\n",
    "dia_idx_inj = dia_detections.index[inj_mask]\n",
    "\n",
    "\n",
    "# Assign the variability sources catalog id to the detections\n",
    "dia_detections[\"id\"] = None\n",
    "dia_detections.loc[dia_idx_stars,\"id\"] = result_sum[\"star\"].iloc[matched_star_idx][\"id\"].to_numpy()\n",
    "dia_detections.loc[dia_idx_sn,\"id\"] = result_sum['sn'].iloc[matched_sn_idx][\"id\"].to_numpy()\n",
    "dia_detections.loc[dia_idx_inj,\"id\"] = result_sum['inject'].iloc[matched_inj_idx][\"injection_id\"].to_numpy()\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 32,
   "id": "e9f517f2-4016-4348-a6dc-da09f4ab0370",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>ra</th>\n",
       "      <th>dec</th>\n",
       "      <th>midpointMjdTai</th>\n",
       "      <th>id</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>diaSourceId</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>1253071204122625</th>\n",
       "      <td>59.253969</td>\n",
       "      <td>-35.865458</td>\n",
       "      <td>59583.120963</td>\n",
       "      <td>17968</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1253071204122626</th>\n",
       "      <td>59.352831</td>\n",
       "      <td>-35.824191</td>\n",
       "      <td>59583.120963</td>\n",
       "      <td>17550</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1253071204122627</th>\n",
       "      <td>59.322393</td>\n",
       "      <td>-35.837479</td>\n",
       "      <td>59583.120963</td>\n",
       "      <td>39378</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1253071204122628</th>\n",
       "      <td>59.187448</td>\n",
       "      <td>-35.894133</td>\n",
       "      <td>59583.120963</td>\n",
       "      <td>31107842865</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1253071204122629</th>\n",
       "      <td>59.357712</td>\n",
       "      <td>-35.822867</td>\n",
       "      <td>59583.120963</td>\n",
       "      <td>12941</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                         ra        dec  midpointMjdTai           id\n",
       "diaSourceId                                                        \n",
       "1253071204122625  59.253969 -35.865458    59583.120963        17968\n",
       "1253071204122626  59.352831 -35.824191    59583.120963        17550\n",
       "1253071204122627  59.322393 -35.837479    59583.120963        39378\n",
       "1253071204122628  59.187448 -35.894133    59583.120963  31107842865\n",
       "1253071204122629  59.357712 -35.822867    59583.120963        12941"
      ]
     },
     "execution_count": 32,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "dia_detections.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c8e17e3d-091f-4258-b8c8-ca7369842f4a",
   "metadata": {},
   "outputs": [],
   "source": [
    "# for now, classify anything that doesn't match truth summary or injection tables as bogus.  \n",
    "# Call anything injected real.  \n",
    "# Ignore the truth summary matches."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 33,
   "id": "eb0d18a7-f14c-4cc9-956c-709397ba6ad6",
   "metadata": {},
   "outputs": [],
   "source": [
    "dia_detections['real'] = np.nan"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 34,
   "id": "5ee589de-7530-4243-b24a-7bda0df7cea7",
   "metadata": {},
   "outputs": [],
   "source": [
    "dia_detections.loc[~(star_mask | sn_mask | inj_mask), 'real'] = 0\n",
    "dia_detections.loc[dia_idx_inj, 'real'] = 1"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 35,
   "id": "5e9e6fa3-bf50-4eaf-b130-a05d9cb04cb9",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "204037"
      ]
     },
     "execution_count": 35,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "np.sum(dia_detections['real'].isna())"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 36,
   "id": "ab6a02d9-0e2d-4112-adc1-a41ccb0b9050",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "88098"
      ]
     },
     "execution_count": 36,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "np.sum(dia_detections['real'] == 0)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 37,
   "id": "a84b7f5e-6768-4af7-8c7a-3e0055c183dc",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "3215924"
      ]
     },
     "execution_count": 37,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "np.sum(dia_detections['real'] == 1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 38,
   "id": "358d7488-d222-40c9-b428-6a728666ea3b",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>ra</th>\n",
       "      <th>dec</th>\n",
       "      <th>midpointMjdTai</th>\n",
       "      <th>id</th>\n",
       "      <th>real</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>diaSourceId</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>1253071204122625</th>\n",
       "      <td>59.253969</td>\n",
       "      <td>-35.865458</td>\n",
       "      <td>59583.120963</td>\n",
       "      <td>17968</td>\n",
       "      <td>1.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1253071204122626</th>\n",
       "      <td>59.352831</td>\n",
       "      <td>-35.824191</td>\n",
       "      <td>59583.120963</td>\n",
       "      <td>17550</td>\n",
       "      <td>1.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1253071204122627</th>\n",
       "      <td>59.322393</td>\n",
       "      <td>-35.837479</td>\n",
       "      <td>59583.120963</td>\n",
       "      <td>39378</td>\n",
       "      <td>1.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1253071204122628</th>\n",
       "      <td>59.187448</td>\n",
       "      <td>-35.894133</td>\n",
       "      <td>59583.120963</td>\n",
       "      <td>31107842865</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1253071204122629</th>\n",
       "      <td>59.357712</td>\n",
       "      <td>-35.822867</td>\n",
       "      <td>59583.120963</td>\n",
       "      <td>12941</td>\n",
       "      <td>1.0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                         ra        dec  midpointMjdTai           id  real\n",
       "diaSourceId                                                              \n",
       "1253071204122625  59.253969 -35.865458    59583.120963        17968   1.0\n",
       "1253071204122626  59.352831 -35.824191    59583.120963        17550   1.0\n",
       "1253071204122627  59.322393 -35.837479    59583.120963        39378   1.0\n",
       "1253071204122628  59.187448 -35.894133    59583.120963  31107842865   NaN\n",
       "1253071204122629  59.357712 -35.822867    59583.120963        12941   1.0"
      ]
     },
     "execution_count": 38,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "dia_detections.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "93135322-d4ad-42d9-ad15-50c0951fe3ed",
   "metadata": {},
   "source": [
    "duplicates code from [here](https://github.com/lsst/analysis_ap/blob/f648f42b89952fea3f8aa3e5145f8f1c87867698/python/lsst/analysis/ap/plotImageSubtractionCutouts.py#L680C1-L682C37)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 41,
   "id": "a614ef6f-566b-40e7-b0ed-42898d9e7c05",
   "metadata": {},
   "outputs": [],
   "source": [
    "def chunker(id, size):\n",
    "    return (id // size)*size\n",
    "\n",
    "def cutout_path(id, size=5000):\n",
    "    return f'numpy/{chunker(id, size)}/{id}_sci_51.npy'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 46,
   "id": "3430ce9d-0fa2-403e-88c1-f6536cb9d968",
   "metadata": {},
   "outputs": [],
   "source": [
    "cutout_paths = pd.Series([cutout_path(i) for i in dia_detections.index.to_numpy()], index=dia_detections.index,\n",
    "                         name='cutout_path')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 49,
   "id": "3b5e8b9d-773e-4305-8cb3-8103be88bf0e",
   "metadata": {},
   "outputs": [],
   "source": [
    "dia_detections.join(cutout_paths).to_csv('../diasources_with_labels.csv.gz')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "333ca19a-73c8-4565-94a1-97cd647eef2f",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f3149efc-7111-4652-b267-7d45b115c514",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f45b7e15-889c-416a-b603-dc2491dfcbad",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "markdown",
   "id": "075f7982-ec0e-48ce-bb0a-c1870f57a74a",
   "metadata": {},
   "source": [
    "** code below is unused for now **"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "fb5b8c22-4cf2-4456-b4f4-b6320081970a",
   "metadata": {},
   "outputs": [],
   "source": [
    "# By default, set on_source = 0 for all values in the exported sources.\n",
    "dia_detections['on_source'] = 0\n",
    "dia_detections['type'] = None"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "34342105-f6cd-49a9-88f5-0e0b1842d637",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>ra</th>\n",
       "      <th>dec</th>\n",
       "      <th>midpointMjdTai</th>\n",
       "      <th>type</th>\n",
       "      <th>on_source</th>\n",
       "      <th>real</th>\n",
       "      <th>id</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>diaSourceId</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>1257927201521665</th>\n",
       "      <td>55.760339</td>\n",
       "      <td>-32.260622</td>\n",
       "      <td>59583.125051</td>\n",
       "      <td>star</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>30321355720</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1257927201521666</th>\n",
       "      <td>55.674078</td>\n",
       "      <td>-32.283857</td>\n",
       "      <td>59583.125051</td>\n",
       "      <td>None</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>None</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1257927201521667</th>\n",
       "      <td>55.552914</td>\n",
       "      <td>-32.306395</td>\n",
       "      <td>59583.125051</td>\n",
       "      <td>None</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>None</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1257927201521668</th>\n",
       "      <td>55.547689</td>\n",
       "      <td>-32.309278</td>\n",
       "      <td>59583.125051</td>\n",
       "      <td>None</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>None</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1257927201521669</th>\n",
       "      <td>55.570127</td>\n",
       "      <td>-32.306400</td>\n",
       "      <td>59583.125051</td>\n",
       "      <td>None</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>None</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>660667525163384915</th>\n",
       "      <td>55.889519</td>\n",
       "      <td>-32.485637</td>\n",
       "      <td>61392.194195</td>\n",
       "      <td>star</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>31411443281</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>661047079476396040</th>\n",
       "      <td>55.863218</td>\n",
       "      <td>-32.167598</td>\n",
       "      <td>61393.204087</td>\n",
       "      <td>star</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>31102009372</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>662500331589992590</th>\n",
       "      <td>55.971559</td>\n",
       "      <td>-32.358853</td>\n",
       "      <td>61404.195949</td>\n",
       "      <td>star</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>31405685742</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>662500331589992596</th>\n",
       "      <td>55.881022</td>\n",
       "      <td>-32.482719</td>\n",
       "      <td>61404.195949</td>\n",
       "      <td>star</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>31411442918</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>662500331589992604</th>\n",
       "      <td>55.875809</td>\n",
       "      <td>-32.505451</td>\n",
       "      <td>61404.195949</td>\n",
       "      <td>star</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>31107747991</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>25446 rows × 7 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "                           ra        dec  midpointMjdTai  type  on_source  \\\n",
       "diaSourceId                                                                 \n",
       "1257927201521665    55.760339 -32.260622    59583.125051  star          1   \n",
       "1257927201521666    55.674078 -32.283857    59583.125051  None          0   \n",
       "1257927201521667    55.552914 -32.306395    59583.125051  None          0   \n",
       "1257927201521668    55.547689 -32.309278    59583.125051  None          0   \n",
       "1257927201521669    55.570127 -32.306400    59583.125051  None          0   \n",
       "...                       ...        ...             ...   ...        ...   \n",
       "660667525163384915  55.889519 -32.485637    61392.194195  star          1   \n",
       "661047079476396040  55.863218 -32.167598    61393.204087  star          1   \n",
       "662500331589992590  55.971559 -32.358853    61404.195949  star          1   \n",
       "662500331589992596  55.881022 -32.482719    61404.195949  star          1   \n",
       "662500331589992604  55.875809 -32.505451    61404.195949  star          1   \n",
       "\n",
       "                    real           id  \n",
       "diaSourceId                            \n",
       "1257927201521665       0  30321355720  \n",
       "1257927201521666       0         None  \n",
       "1257927201521667       0         None  \n",
       "1257927201521668       0         None  \n",
       "1257927201521669       0         None  \n",
       "...                  ...          ...  \n",
       "660667525163384915     0  31411443281  \n",
       "661047079476396040     0  31102009372  \n",
       "662500331589992590     0  31405685742  \n",
       "662500331589992596     0  31411442918  \n",
       "662500331589992604     0  31107747991  \n",
       "\n",
       "[25446 rows x 7 columns]"
      ]
     },
     "execution_count": 8,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# The spatially matched detections get on_source = 1\n",
    "\n",
    "dia_detections.loc[dia_idx_sn, \"on_source\"] = 1\n",
    "dia_detections.loc[dia_idx_stars , \"on_source\"] = 1\n",
    "dia_detections.loc[dia_idx_sn, \"type\"] = \"sn\"\n",
    "dia_detections.loc[dia_idx_stars, \"type\"] = \"star\"\n",
    "dia_detections"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "45b9332a-e08b-4495-b817-76f351afc22f",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Summary at the end of First Stage:\n",
      "detections on a source 7301 \n",
      "\n",
      "class detection: type\n",
      "sn       146\n",
      "star    7155\n",
      "Name: ra, dtype: int64\n"
     ]
    }
   ],
   "source": [
    "# Print a summary at the end of first round of matching.\n",
    "print(\"Summary at the end of First Stage:\")\n",
    "print(f\"detections on a source\", dia_detections[\"on_source\"].sum(), \"\\n\")\n",
    "print(f\"class detection: {dia_detections.groupby('type').count().iloc[:,0]}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ac6f1b4e-dd76-4284-867e-839b61969d70",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0f75fab4-5787-4bda-ada2-9b9a0ac2334c",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e03ebbdb-fe09-4065-bf68-09df9b715fc5",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "8b600421-0b6a-488f-8fdf-15b59b73ae81",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "23204aec-933a-492f-b6c8-e56eb9e314af",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0c85f539-95d1-4721-8138-5eb96847b11a",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f61f1b08-26a7-4cbe-a077-c50d237950f0",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "11e8e631-4585-4930-8c81-9189e993d5d2",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "markdown",
   "id": "bfbc1516-e7c2-49d3-afed-098fa8c30b8d",
   "metadata": {},
   "source": [
    "## Stage 2: Match sources in time.\n",
    "\n",
    "We are deferring the DC2 truth match for now because the number of MJD matches is not large."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "e71f8b23-b853-4e8a-8196-3c1d689b0fb4",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "working on class: sn\n",
      "need to examine 12757691 variability entries\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "100%|█████████████████████████████████████████| 146/146 [00:01<00:00, 91.96it/s]\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>ra</th>\n",
       "      <th>dec</th>\n",
       "      <th>midpointMjdTai</th>\n",
       "      <th>type</th>\n",
       "      <th>on_source</th>\n",
       "      <th>real</th>\n",
       "      <th>id</th>\n",
       "      <th>not_in_truth_var</th>\n",
       "      <th>min_mjd_offset</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>diaSourceId</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>85627704270914249</th>\n",
       "      <td>55.734059</td>\n",
       "      <td>-32.316071</td>\n",
       "      <td>59791.360480</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>5056389737494</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>95252785037049908</th>\n",
       "      <td>55.734090</td>\n",
       "      <td>-32.316053</td>\n",
       "      <td>59813.364076</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>5056389737494</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>97640275215646752</th>\n",
       "      <td>55.734070</td>\n",
       "      <td>-32.316099</td>\n",
       "      <td>59821.276470</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>5056389737494</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>97657362206163020</th>\n",
       "      <td>55.734072</td>\n",
       "      <td>-32.316068</td>\n",
       "      <td>59821.291001</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>5056389737494</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>161196052894974023</th>\n",
       "      <td>55.685292</td>\n",
       "      <td>-32.308088</td>\n",
       "      <td>60001.075928</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224016890902</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>164379687202586649</th>\n",
       "      <td>55.685270</td>\n",
       "      <td>-32.308128</td>\n",
       "      <td>60009.044807</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224016890902</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>278114224394207329</th>\n",
       "      <td>55.746318</td>\n",
       "      <td>-32.272641</td>\n",
       "      <td>60338.139110</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224016644118</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>286057742248968251</th>\n",
       "      <td>55.746346</td>\n",
       "      <td>-32.272636</td>\n",
       "      <td>60362.072829</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224016644118</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>341338831640854570</th>\n",
       "      <td>55.756720</td>\n",
       "      <td>-32.300051</td>\n",
       "      <td>60528.318074</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224020316182</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>341357091157442660</th>\n",
       "      <td>55.756743</td>\n",
       "      <td>-32.300082</td>\n",
       "      <td>60528.333570</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224020316182</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>342457652904722669</th>\n",
       "      <td>55.756765</td>\n",
       "      <td>-32.300058</td>\n",
       "      <td>60530.355550</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224020316182</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000101</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>342962846285430848</th>\n",
       "      <td>55.756760</td>\n",
       "      <td>-32.300047</td>\n",
       "      <td>60531.327979</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224020316182</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>343039123830865946</th>\n",
       "      <td>55.756746</td>\n",
       "      <td>-32.300077</td>\n",
       "      <td>60531.394166</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224020316182</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>345230015102713919</th>\n",
       "      <td>55.756748</td>\n",
       "      <td>-32.300045</td>\n",
       "      <td>60536.295524</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224020316182</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>348166212049436764</th>\n",
       "      <td>55.756753</td>\n",
       "      <td>-32.300088</td>\n",
       "      <td>60542.294638</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224020316182</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>348186613144092681</th>\n",
       "      <td>55.756739</td>\n",
       "      <td>-32.300077</td>\n",
       "      <td>60542.312628</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224020316182</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>348223636835926049</th>\n",
       "      <td>55.756781</td>\n",
       "      <td>-32.300101</td>\n",
       "      <td>60542.345045</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224020316182</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>351362700657295472</th>\n",
       "      <td>55.756703</td>\n",
       "      <td>-32.300073</td>\n",
       "      <td>60549.272587</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224020316182</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000100</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>351363319669456940</th>\n",
       "      <td>55.756695</td>\n",
       "      <td>-32.300074</td>\n",
       "      <td>60549.273034</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224020316182</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000101</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>351363794800214114</th>\n",
       "      <td>55.756753</td>\n",
       "      <td>-32.300068</td>\n",
       "      <td>60549.273482</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224020316182</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>351379903611928620</th>\n",
       "      <td>55.756702</td>\n",
       "      <td>-32.300083</td>\n",
       "      <td>60549.287105</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224020316182</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>355221811450872090</th>\n",
       "      <td>55.756784</td>\n",
       "      <td>-32.300028</td>\n",
       "      <td>60559.302831</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224020316182</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>405771409713791040</th>\n",
       "      <td>55.830173</td>\n",
       "      <td>-32.331817</td>\n",
       "      <td>60696.136692</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224650927126</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>487997976627642371</th>\n",
       "      <td>55.956356</td>\n",
       "      <td>-32.368539</td>\n",
       "      <td>60904.380613</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224313309206</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>491618669491650998</th>\n",
       "      <td>55.956362</td>\n",
       "      <td>-32.368529</td>\n",
       "      <td>60912.324638</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224313309206</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>496114968211488916</th>\n",
       "      <td>55.753912</td>\n",
       "      <td>-32.253740</td>\n",
       "      <td>60937.263806</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4225026305046</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>636277479094353933</th>\n",
       "      <td>55.945609</td>\n",
       "      <td>-32.353280</td>\n",
       "      <td>61318.333201</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224448081942</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>636297807174565911</th>\n",
       "      <td>55.945607</td>\n",
       "      <td>-32.353279</td>\n",
       "      <td>61318.351789</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224448081942</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>636760137318531161</th>\n",
       "      <td>55.945618</td>\n",
       "      <td>-32.353251</td>\n",
       "      <td>61319.363939</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224448081942</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>645816020564443201</th>\n",
       "      <td>55.945600</td>\n",
       "      <td>-32.353267</td>\n",
       "      <td>61343.105723</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224448081942</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000100</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>660667525163384854</th>\n",
       "      <td>55.945622</td>\n",
       "      <td>-32.353261</td>\n",
       "      <td>61392.194195</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224448081942</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>93738742493216770</th>\n",
       "      <td>55.734081</td>\n",
       "      <td>-32.316066</td>\n",
       "      <td>59810.381776</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>5056389737494</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>225905618777538634</th>\n",
       "      <td>55.619536</td>\n",
       "      <td>-32.227419</td>\n",
       "      <td>60179.353690</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>5056465707030</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>278114224394207312</th>\n",
       "      <td>55.619952</td>\n",
       "      <td>-32.235140</td>\n",
       "      <td>60338.139110</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>5056016222230</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>289069573032902730</th>\n",
       "      <td>55.746311</td>\n",
       "      <td>-32.272632</td>\n",
       "      <td>60369.030714</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224016644118</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>343017058973253667</th>\n",
       "      <td>55.929655</td>\n",
       "      <td>-32.427467</td>\n",
       "      <td>60531.374974</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>41021617522</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>343018160632365243</th>\n",
       "      <td>55.756722</td>\n",
       "      <td>-32.300056</td>\n",
       "      <td>60531.375875</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224020316182</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>407778182180110377</th>\n",
       "      <td>55.830114</td>\n",
       "      <td>-32.331786</td>\n",
       "      <td>60701.123060</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224650927126</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>479854721318780936</th>\n",
       "      <td>55.823223</td>\n",
       "      <td>-32.241916</td>\n",
       "      <td>60887.403224</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224457747478</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>487999617842020420</th>\n",
       "      <td>55.956362</td>\n",
       "      <td>-32.368533</td>\n",
       "      <td>60904.381976</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224313309206</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>496099340436111427</th>\n",
       "      <td>55.753915</td>\n",
       "      <td>-32.253749</td>\n",
       "      <td>60937.250689</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4225026305046</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>514655207620083750</th>\n",
       "      <td>55.927975</td>\n",
       "      <td>-32.498102</td>\n",
       "      <td>60991.073999</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>5056085748758</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>638865685442723935</th>\n",
       "      <td>55.945603</td>\n",
       "      <td>-32.353276</td>\n",
       "      <td>61324.220001</td>\n",
       "      <td>sn</td>\n",
       "      <td>1</td>\n",
       "      <td>True</td>\n",
       "      <td>4224448081942</td>\n",
       "      <td>False</td>\n",
       "      <td>0.000347</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                           ra        dec  midpointMjdTai type  on_source  \\\n",
       "diaSourceId                                                                \n",
       "85627704270914249   55.734059 -32.316071    59791.360480   sn          1   \n",
       "95252785037049908   55.734090 -32.316053    59813.364076   sn          1   \n",
       "97640275215646752   55.734070 -32.316099    59821.276470   sn          1   \n",
       "97657362206163020   55.734072 -32.316068    59821.291001   sn          1   \n",
       "161196052894974023  55.685292 -32.308088    60001.075928   sn          1   \n",
       "164379687202586649  55.685270 -32.308128    60009.044807   sn          1   \n",
       "278114224394207329  55.746318 -32.272641    60338.139110   sn          1   \n",
       "286057742248968251  55.746346 -32.272636    60362.072829   sn          1   \n",
       "341338831640854570  55.756720 -32.300051    60528.318074   sn          1   \n",
       "341357091157442660  55.756743 -32.300082    60528.333570   sn          1   \n",
       "342457652904722669  55.756765 -32.300058    60530.355550   sn          1   \n",
       "342962846285430848  55.756760 -32.300047    60531.327979   sn          1   \n",
       "343039123830865946  55.756746 -32.300077    60531.394166   sn          1   \n",
       "345230015102713919  55.756748 -32.300045    60536.295524   sn          1   \n",
       "348166212049436764  55.756753 -32.300088    60542.294638   sn          1   \n",
       "348186613144092681  55.756739 -32.300077    60542.312628   sn          1   \n",
       "348223636835926049  55.756781 -32.300101    60542.345045   sn          1   \n",
       "351362700657295472  55.756703 -32.300073    60549.272587   sn          1   \n",
       "351363319669456940  55.756695 -32.300074    60549.273034   sn          1   \n",
       "351363794800214114  55.756753 -32.300068    60549.273482   sn          1   \n",
       "351379903611928620  55.756702 -32.300083    60549.287105   sn          1   \n",
       "355221811450872090  55.756784 -32.300028    60559.302831   sn          1   \n",
       "405771409713791040  55.830173 -32.331817    60696.136692   sn          1   \n",
       "487997976627642371  55.956356 -32.368539    60904.380613   sn          1   \n",
       "491618669491650998  55.956362 -32.368529    60912.324638   sn          1   \n",
       "496114968211488916  55.753912 -32.253740    60937.263806   sn          1   \n",
       "636277479094353933  55.945609 -32.353280    61318.333201   sn          1   \n",
       "636297807174565911  55.945607 -32.353279    61318.351789   sn          1   \n",
       "636760137318531161  55.945618 -32.353251    61319.363939   sn          1   \n",
       "645816020564443201  55.945600 -32.353267    61343.105723   sn          1   \n",
       "660667525163384854  55.945622 -32.353261    61392.194195   sn          1   \n",
       "93738742493216770   55.734081 -32.316066    59810.381776   sn          1   \n",
       "225905618777538634  55.619536 -32.227419    60179.353690   sn          1   \n",
       "278114224394207312  55.619952 -32.235140    60338.139110   sn          1   \n",
       "289069573032902730  55.746311 -32.272632    60369.030714   sn          1   \n",
       "343017058973253667  55.929655 -32.427467    60531.374974   sn          1   \n",
       "343018160632365243  55.756722 -32.300056    60531.375875   sn          1   \n",
       "407778182180110377  55.830114 -32.331786    60701.123060   sn          1   \n",
       "479854721318780936  55.823223 -32.241916    60887.403224   sn          1   \n",
       "487999617842020420  55.956362 -32.368533    60904.381976   sn          1   \n",
       "496099340436111427  55.753915 -32.253749    60937.250689   sn          1   \n",
       "514655207620083750  55.927975 -32.498102    60991.073999   sn          1   \n",
       "638865685442723935  55.945603 -32.353276    61324.220001   sn          1   \n",
       "\n",
       "                    real             id  not_in_truth_var  min_mjd_offset  \n",
       "diaSourceId                                                                \n",
       "85627704270914249   True  5056389737494             False        0.000347  \n",
       "95252785037049908   True  5056389737494             False        0.000347  \n",
       "97640275215646752   True  5056389737494             False        0.000347  \n",
       "97657362206163020   True  5056389737494             False        0.000347  \n",
       "161196052894974023  True  4224016890902             False        0.000347  \n",
       "164379687202586649  True  4224016890902             False        0.000347  \n",
       "278114224394207329  True  4224016644118             False        0.000347  \n",
       "286057742248968251  True  4224016644118             False        0.000347  \n",
       "341338831640854570  True  4224020316182             False        0.000347  \n",
       "341357091157442660  True  4224020316182             False        0.000347  \n",
       "342457652904722669  True  4224020316182             False        0.000101  \n",
       "342962846285430848  True  4224020316182             False        0.000347  \n",
       "343039123830865946  True  4224020316182             False        0.000347  \n",
       "345230015102713919  True  4224020316182             False        0.000347  \n",
       "348166212049436764  True  4224020316182             False        0.000347  \n",
       "348186613144092681  True  4224020316182             False        0.000347  \n",
       "348223636835926049  True  4224020316182             False        0.000347  \n",
       "351362700657295472  True  4224020316182             False        0.000100  \n",
       "351363319669456940  True  4224020316182             False        0.000101  \n",
       "351363794800214114  True  4224020316182             False        0.000347  \n",
       "351379903611928620  True  4224020316182             False        0.000347  \n",
       "355221811450872090  True  4224020316182             False        0.000347  \n",
       "405771409713791040  True  4224650927126             False        0.000347  \n",
       "487997976627642371  True  4224313309206             False        0.000347  \n",
       "491618669491650998  True  4224313309206             False        0.000347  \n",
       "496114968211488916  True  4225026305046             False        0.000347  \n",
       "636277479094353933  True  4224448081942             False        0.000347  \n",
       "636297807174565911  True  4224448081942             False        0.000347  \n",
       "636760137318531161  True  4224448081942             False        0.000347  \n",
       "645816020564443201  True  4224448081942             False        0.000100  \n",
       "660667525163384854  True  4224448081942             False        0.000347  \n",
       "93738742493216770   True  5056389737494             False        0.000347  \n",
       "225905618777538634  True  5056465707030             False        0.000347  \n",
       "278114224394207312  True  5056016222230             False        0.000347  \n",
       "289069573032902730  True  4224016644118             False        0.000347  \n",
       "343017058973253667  True    41021617522             False        0.000347  \n",
       "343018160632365243  True  4224020316182             False        0.000347  \n",
       "407778182180110377  True  4224650927126             False        0.000347  \n",
       "479854721318780936  True  4224457747478             False        0.000347  \n",
       "487999617842020420  True  4224313309206             False        0.000347  \n",
       "496099340436111427  True  4225026305046             False        0.000347  \n",
       "514655207620083750  True  5056085748758             False        0.000347  \n",
       "638865685442723935  True  4224448081942             False        0.000347  "
      ]
     },
     "execution_count": 11,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "\n",
    "matched = {}\n",
    "matched[\"sn\"] = dia_detections.loc[dia_idx_sn]\n",
    "matched[\"star\"] = dia_detections.loc[dia_idx_stars]\n",
    "\n",
    "# make a column to report cases where there is no variability entry for that truth id\n",
    "dia_detections['not_in_truth_var'] = False\n",
    "# make a column to store minimum MJD difference\n",
    "dia_detections['min_mjd_offset'] = np.inf\n",
    "\n",
    "for s in [\"sn\"]:\n",
    "#for s in [\"sn\", \"star\"]:\n",
    "\n",
    "\n",
    "    print(f\"working on class: {s}\")\n",
    "    \n",
    "    # Get a list of all the unique MJDs of sources that matched in the previous stage for the object type.\n",
    "    mjd_matched_in_space = matched[s].midpointMjdTai.unique()\n",
    "\n",
    "    # Get min and max MJD values required for matching.\n",
    "    max_mjd, min_mjd = mjd_matched_in_space.max(), mjd_matched_in_space.min()\n",
    "\n",
    "    # Read star/sn lightcurve variability parquet for the object type\n",
    "    df_var = pd.read_parquet(var_path[s])\n",
    "    \n",
    "    # Filter out records with unwanted MJDs.\n",
    "    df_var = df_var[(df_var.MJD >= min_mjd) & (df_var.MJD <= max_mjd)]\n",
    "    print(f\"need to examine {len(df_var)} variability entries\")\n",
    "    \n",
    "    for detected in tqdm(matched[s].index): #loop over indices of on_source detection \n",
    "        mask_matching_ids = df_var.id == matched[s].loc[detected, 'id'] #mask for sources with matching id in variability file \n",
    "        if np.sum(mask_matching_ids) == 0:\n",
    "            dia_detections.loc[detected, 'not_in_truth_var'] = True\n",
    "        else:\n",
    "            dia_detections.loc[detected, 'min_mjd_offset'] = np.min(np.abs(df_var[mask_matching_ids].MJD - \n",
    "                                                                           matched[s].loc[detected].midpointMjdTai))\n",
    "            dia_detections.loc[detected, \"real\"] = dia_detections.loc[detected, 'min_mjd_offset'] <= MJD_tolerance\n",
    "    del df_var\n",
    "\n",
    "dia_detections[dia_detections.real == 1]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "a6cf401b-9b5d-4fdb-ba59-cb470fd62b77",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>type</th>\n",
       "      <th>not_in_truth_var</th>\n",
       "      <th>min_mjd_offset</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>diaSourceId</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>85620264850686737</th>\n",
       "      <td>sn</td>\n",
       "      <td>False</td>\n",
       "      <td>0.006872</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>662500331589992579</th>\n",
       "      <td>sn</td>\n",
       "      <td>False</td>\n",
       "      <td>10.015978</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>514651499452694538</th>\n",
       "      <td>sn</td>\n",
       "      <td>False</td>\n",
       "      <td>14.951599</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>514655207620083813</th>\n",
       "      <td>sn</td>\n",
       "      <td>False</td>\n",
       "      <td>14.954745</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>514672918991470638</th>\n",
       "      <td>sn</td>\n",
       "      <td>False</td>\n",
       "      <td>14.969620</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>372269053118513218</th>\n",
       "      <td>sn</td>\n",
       "      <td>True</td>\n",
       "      <td>inf</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>242418712005574688</th>\n",
       "      <td>sn</td>\n",
       "      <td>True</td>\n",
       "      <td>inf</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>242392416068304901</th>\n",
       "      <td>sn</td>\n",
       "      <td>True</td>\n",
       "      <td>inf</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>642315619533848634</th>\n",
       "      <td>sn</td>\n",
       "      <td>True</td>\n",
       "      <td>inf</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>645816020564443154</th>\n",
       "      <td>sn</td>\n",
       "      <td>True</td>\n",
       "      <td>inf</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>103 rows × 3 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "                   type  not_in_truth_var  min_mjd_offset\n",
       "diaSourceId                                              \n",
       "85620264850686737    sn             False        0.006872\n",
       "662500331589992579   sn             False       10.015978\n",
       "514651499452694538   sn             False       14.951599\n",
       "514655207620083813   sn             False       14.954745\n",
       "514672918991470638   sn             False       14.969620\n",
       "...                 ...               ...             ...\n",
       "372269053118513218   sn              True             inf\n",
       "242418712005574688   sn              True             inf\n",
       "242392416068304901   sn              True             inf\n",
       "642315619533848634   sn              True             inf\n",
       "645816020564443154   sn              True             inf\n",
       "\n",
       "[103 rows x 3 columns]"
      ]
     },
     "execution_count": 14,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "dia_detections.loc[(dia_detections.real == 0) & (dia_detections.on_source == 1) & (dia_detections.type == 'sn'), \n",
    "['type','not_in_truth_var', 'min_mjd_offset'] ].sort_values('min_mjd_offset')"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "9bccde7a-fbf3-4c17-98f3-34e3e6c93b0b",
   "metadata": {},
   "source": [
    "next step: look at image stamps to see if we can understand the behavior of some of this cases where there's no match in variability (either by MJD or by id)."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "df89b8c8-de75-49bf-a04d-7eafc33f9c43",
   "metadata": {},
   "source": [
    "At a first look at the SN, these look like boguses apart from 85620264850686737 which is only an hour or so from a truth MJD.  Lots of bad galaxy supernova."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7b880668-ef72-407c-9857-52c9418c4113",
   "metadata": {},
   "source": [
    "Need to check missing detections...  we don't have cutouts for those"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "8317dbd0-c119-433c-8763-034dcf46e0dd",
   "metadata": {},
   "source": [
    "add a bunch of fakes to the DC2 images to enhance truth sample in the short term, to get us a functional model for comcam"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "57fc8409-4c58-49f9-a45d-e75378066ceb",
   "metadata": {},
   "outputs": [],
   "source": [
    "variable stars: feed in the ML features from the dipole fitter?"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0f544124-1260-4ca7-aac8-dd6ed63c5814",
   "metadata": {},
   "source": [
    "figure out by MJD how many SN we have have epochs we didn't process"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.4"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
